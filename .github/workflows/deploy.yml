name: Deploy to EC2

# main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ìë™ ë°°í¬
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Java 17 ì„¤ì¹˜ (ë°±ì—”ë“œ ë¹Œë“œìš©)
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. Node.js ì„¤ì¹˜ (í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œìš©)
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: nawbio-web/package-lock.json

    # 4. ë°±ì—”ë“œ ë¹Œë“œ
    - name: Build Backend
      run: |
        cd nawbio-api
        chmod +x gradlew
        ./gradlew clean bootJar

    # 5. ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ (ì„ íƒ)
    - name: Test Backend
      run: |
        cd nawbio-api
        ./gradlew test
      continue-on-error: true  # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•´ë„ ë°°í¬ ì§„í–‰

    # 6. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
    - name: Build Frontend
      env:
        REACT_APP_API_URL: https://api.nawbio.com
      run: |
        cd nawbio-web
        npm ci
        npm run build

    # 7. EC2 SSH í‚¤ ì„¤ì •
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    # 8. ë°±ì—”ë“œ ë°°í¬
    - name: Deploy Backend to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
      run: |
        # JAR íŒŒì¼ ì—…ë¡œë“œ
        scp -i ~/.ssh/id_rsa \
          nawbio-api/build/libs/nawbio-api-0.0.1-SNAPSHOT.jar \
          $EC2_USERNAME@$EC2_HOST:/home/$EC2_USERNAME/nawbio-api-new.jar

        # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
        ssh -i ~/.ssh/id_rsa $EC2_USERNAME@$EC2_HOST << 'ENDSSH'
          # ë°±ì—…
          if [ -f ~/nawbio-api.jar ]; then
            mkdir -p ~/backups
            cp ~/nawbio-api.jar ~/backups/nawbio-api-backup-$(date +%Y%m%d-%H%M%S).jar
          fi

          # JAR êµì²´
          mv ~/nawbio-api-new.jar ~/nawbio-api.jar

          # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          sudo systemctl restart nawbio-api

          # ìƒíƒœ í™•ì¸
          sleep 5
          sudo systemctl status nawbio-api
        ENDSSH

    # 9. í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
    - name: Deploy Frontend to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
      run: |
        # ë¹Œë“œ íŒŒì¼ ì—…ë¡œë“œ (tarë¡œ ì••ì¶•í•´ì„œ ë¹ ë¥´ê²Œ)
        cd nawbio-web
        tar -czf build.tar.gz build
        scp -i ~/.ssh/id_rsa build.tar.gz $EC2_USERNAME@$EC2_HOST:/tmp/

        # EC2ì—ì„œ ì••ì¶• í•´ì œ ë° ë°°í¬
        ssh -i ~/.ssh/id_rsa $EC2_USERNAME@$EC2_HOST << 'ENDSSH'
          # ë°±ì—…
          if [ -d /var/www/nawbio-web/build ]; then
            sudo mkdir -p /var/www/nawbio-web/backups
            sudo cp -r /var/www/nawbio-web/build \
              /var/www/nawbio-web/backups/build-backup-$(date +%Y%m%d-%H%M%S)
          fi

          # ì••ì¶• í•´ì œ
          cd /tmp
          tar -xzf build.tar.gz

          # íŒŒì¼ ë³µì‚¬
          sudo rm -rf /var/www/nawbio-web/build/*
          sudo cp -r build/* /var/www/nawbio-web/build/

          # ê¶Œí•œ ì„¤ì •
          sudo chown -R nginx:nginx /var/www/nawbio-web/build
          sudo chmod -R 755 /var/www/nawbio-web/build

          # ì •ë¦¬
          rm -rf /tmp/build /tmp/build.tar.gz
        ENDSSH

    # 10. í—¬ìŠ¤ì²´í¬
    - name: Health Check
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
      run: |
        sleep 10

        # ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬
        ssh -i ~/.ssh/id_rsa $EC2_USERNAME@$EC2_HOST \
          'curl -f http://localhost:8080/api/health || exit 1'

        echo "âœ… Backend is healthy"

        # í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬
        ssh -i ~/.ssh/id_rsa $EC2_USERNAME@$EC2_HOST \
          'curl -f -I http://localhost || exit 1'

        echo "âœ… Frontend is healthy"

    # 11. ë°°í¬ ì„±ê³µ ì•Œë¦¼ (ì„ íƒ)
    - name: Notify Success
      if: success()
      run: |
        echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"

    # 12. ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
    - name: Notify Failure
      if: failure()
      run: |
        echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
